name: ğŸš€ Deploy to EC2 via Git Pull + Docker Compose

on:
  pull_request:
    types: [closed]
    branches: [develop] # Deploy khi PR Ä‘Æ°á»£c merge vÃ o develop

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (for Actions context)
        uses: actions/checkout@v4

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -e

            echo "ğŸ“‚ Navigating to project folder..."
            cd /home/ubuntu/pharma-app/pharma-identity-service

            echo "ğŸ”„ Pulling latest code..."
            git fetch origin develop
            git reset --hard origin/develop

            echo "ğŸ§¹ Stopping previous containers..."
            
            cd pharma-identity-service
            
            sudo docker-compose down || true

            echo "ğŸ› ï¸ Building new Docker images..."
            sudo docker-compose -f docker-compose.yml build --no-cache

            echo "ğŸš€ Starting new containers..."
            sudo docker-compose -f docker-compose.yml up -d

            echo "ğŸ§½ Cleaning up old images..."
            sudo docker system prune -af

            echo "âœ… Deployment complete!"

      # ----------------------------------------
      # Verify deployment health
      # ----------------------------------------
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            echo "â³ Waiting for services to start..."
            sleep 15
            
            echo "ğŸ” Checking running containers..."
            sudo docker ps
            
            echo "ğŸŒ Checking API health endpoint..."
            curl -f http://localhost:8080/api/health || (echo "âŒ Health check failed!" && exit 1)
            
            echo "âœ… Deployment verified successfully!"
